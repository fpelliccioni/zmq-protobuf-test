# PROJECT NAME
# Copyright ...
# Distributed under the ..

enable_testing()

add_custom_target(syntactic_checks ALL
    COMMAND ${CMAKE_CTEST_COMMAND} -C Debug --output-on-failure -R "check.+"
    COMMENT "Check for multiple definition errors.")


file(GLOB ZMQPROTOBUF_HEADERS
     RELATIVE "${PROJECT_SOURCE_DIR}/include"
     "${PROJECT_SOURCE_DIR}/include/zmq-protobuf-test/*.hpp")

# file(GLOB ZMQPROTOBUF_ALGORITHM_HEADERS
#      RELATIVE "${PROJECT_SOURCE_DIR}/include"
#      "${PROJECT_SOURCE_DIR}/include/zmq-protobuf-test/zmq-protobuf-test/*.hpp")

set(CONTENTS "// This file is auto-generated by CMake to check for multiple definition errors.\n")


# foreach(HEADER ${ZMQPROTOBUF_HEADERS} ${ZMQPROTOBUF_ALGORITHM_HEADERS})
foreach(HEADER ${ZMQPROTOBUF_HEADERS})
    set(CONTENTS "${CONTENTS}#include <${HEADER}>\n")
endforeach()

set(SOURCE_ONE "${CMAKE_CURRENT_BINARY_DIR}/translation_unit_one.cpp")
file(WRITE "${SOURCE_ONE}" "${CONTENTS}\nint main() { return 0; }\n")

set(SOURCE_TWO "${CMAKE_CURRENT_BINARY_DIR}/translation_unit_two.cpp")
file(WRITE "${SOURCE_TWO}" "${CONTENTS}\n")

add_executable(check.multiple.definitions EXCLUDE_FROM_ALL ${SOURCE_ONE} ${SOURCE_TWO})
add_test(NAME check.multiple.definitions COMMAND check.multiple.definitions)
add_dependencies(syntactic_checks check.multiple.definitions)
